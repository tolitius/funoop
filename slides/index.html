<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Clojure Bits on JVM</title>
    <style>
      @import url(css/droid-serif.css);
      @import url(css/yanone-kaffeesatz.css);
      @import url(css/ubuntu-mono.css);
    </style>
    <link rel="stylesheet" type="text/css" href="css/bits.css">
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse
---
class: first-slide
#Clojure Bits on JVM
###by [@tolitius](https://twitter.com/tolitius)
---
class: vs-slide-1
layout: false
---
class: vs-slide-2
layout: false
---
class: vs-slide-2
.vs-common[
##state management
]
---
class: vs-slide-2
layout: false
.vs-common[
##state management
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration
]
---
class: vs-slide-2
layout: false
.vs-common[
##state management
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data stores
]
---
class: vs-slide-2
layout: false
.vs-common[
##state management
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data stores
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messaging
]
---
class: vs-slide-2
layout: false
.vs-common[
##state management
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data stores
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messaging
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aop
]
---
class: vs-slide-2
layout: false
.vs-common[
##state management
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data stores
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messaging
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aop
##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portability
]
---
name: inverse
layout: true
class: center, middle, inverse
---
# designing with [nouns]()
---
# designing with [nouns]()
.right-column[
.lleft[
### - nouns become .lhl[components]
]
]
---
# designing with [nouns]()
.right-column[
.lleft[
### - nouns become .lhl[components]
### - they talk via .lhl[message passing]
]
]
---
# designing with [nouns]()
.right-column[
.lleft[
### - nouns become .lhl[components]
### - they talk via .lhl[message passing]
### - maps naturally to .lhl[Object Oriented] design
]
]
---
# designing with [nouns]()
.right-column[
.lleft[
### - nouns become .lhl[components]
### - they talk via .lhl[message passing]
### - maps naturally to .lhl[Object Oriented] design
.sub-left[
### components are .jhl[classes]<br/><br/><br/></br>
### message passing done via .jhl[method calls]
]]]
---
class: inverse, middle, center
# ... it is not the [only way]()
---
class: inverse, middle, center
# data [|]() data [|]() data
---
class: inverse, middle, center
# data [|]() data [|]() data
## focus on .lhl[data] and its .lhl[transformation]
---
class: inverse, middle
.pull-right[
<img class="curiosity" src="img/curiosuty.png">
]
.pull-left[
.right[
## Hi! I am .lhl[Curiosity]
]
]
---
class: inverse, middle, jpl
.pull-right[
<img class="curiosity" src="img/curiosuty.png">
]
.pull-left[
.right[
## Hi! I am .lhl[Curiosity]
### [J]()et [P]()ropulsion [L]()aboratory at NASA
.jleft[
.left[
* move .jhl[forward 42] meters
* turn .jhl[28 degrees] to the .jhl[left]
* travel .jhl[forward 34] more meters
]]]]
---
class: inverse, middle, jpl
.pull-right[
<img class="curiosity" src="img/curiosuty.png">
]
.pull-left[
.right[
## Hi! I am .lhl[Curiosity]
### [J]()et [P]()ropulsion [L]()aboratory at NASA
.jleft[
.left[
* move .jhl[forward 42] meters
* turn .jhl[28 degrees] to the .jhl[left]
* travel .jhl[forward 34] more meters
]]
.center[
### [D]()eep [S]()pace [N]()etwork
<img class="dsn" src="img/deep-space-network.png">
]]]
---
class: middle, center, mission
---
layout: false
class: middle
.mission-thumb[
<img src="img/mission-thumb.png" width="62%"/>
]
.left-column[
.mtop-minus-46[
  ## [OOP]() design
  ### .oop-focus[.rcc[focus on .rcch[nouns]]]
]]
.right-column[
.mtop-minus-46[
.bq[
.oop-way[
* at least one class for <b>JPL</b>

* at least one class for the <b>Rover</b> itself

* library for <b>Deep Space Network</b> (a prototype class)

* at least one class for <b>Navigator</b>

* at least one class for each <b>Instrument</b>
]]]]
---
layout: false
class: middle
.mission-thumb[
<img src="img/mission-thumb.png" width="62%"/>
]
.left-column[
.mtop-minus-46[
  ## [OOP]() design
  ### .oop-focus[.rcc[focus on .rcch[nouns]]]
]]
.right-column[
.mtop-minus-46[
.bq[
.oop-way[
* at least one class for <b>JPL</b>

* at least one class for the <b>Rover</b> itself

* library for <b>Deep Space Network</b> (a prototype class)

* at least one class for <b>Navigator</b>

* at least one class for each <b>Instrument</b>
]]]
.solid-w[
.oop-solid[
design approach............                           [S.O.L.I.D. .check[✔]]
]]]
---
layout: false
class: middle, center
.mission-fthumb[
<img src="img/mission-thumb.png" width="62%"/>
]

.fp-focus[
### .oop-focus[.rcc[focus on .rcch[data] and its .rcch[transformation]]]
]
.mleft-column[
  ## [FP]()
]
.mright-column[
.bq[
.oop-way[
* navigation commands are sent to the Deep Space Network

* navigation commands are split and sent in sequence to navigator

* low level engine commands are sent to move the rover

* capture commands are sent to cameras

* image events are sent back to the Deep Space Network

* image events are stored at JPL
]]]
---
layout: false
class: middle, center
.mission-fthumb[
<img src="img/mission-thumb.png" width="62%"/>
]

.fp-focus[
### .oop-focus[.rcc[focus on .rcch[data] and its .rcch[transformation]]]
]
.mleft-column[
  ## [FP]()
]
.mright-column[
.bq[
.oop-way[
.fgr[
* .ffd[navigation commands] are .ffd[sent] to the Deep Space Network

* .ffd[navigation commands] are .ffd[split] and .ffd[sent] in sequence to navigator

* low level .ffd[engine commands] are .ffd[sent] to move the rover

* .ffd[capture commands] are .ffd[sent] to cameras

* .ffd[image events] are .ffd[sent] back to the Deep Space Network

* .ffd[image events] are .ffd[stored] at JPL
]]]]
---
class: inverse, middle, center, ccol
## commands [&gt;]() send [&gt;]() navigate [&gt;]() capture [&gt;]() send back
---
class: inverse, middle, center, ccol
## commands [|]() send [|]() navigate [|]() capture [|]() send back

---
class: inverse, middle, center, ccol
## commands [|]() send [|]() navigate [|]() capture [|]() send back

.shell[
$ .lhl[cut] -f 2 data | .lhl[sort] -o | .lhl[uniq] -c
]
---
class: inverse, middle, center, ccol
## commands [|]() send [|]() navigate [|]() capture [|]() send back

.shell[
$ .lhl[cut] -f 2 data | .lhl[sort] -o | .lhl[uniq] -c
]

## v1 [&gt;]() v2 [&gt;]() v3 [&gt;]() v4 [&gt;]() ... [&gt;]() v42
---
class: inverse, middle, center, ccol
## commands [|]() send [|]() navigate [|]() capture [|]() send back

.shell[
$ .lhl[cut] -f 2 data | .lhl[sort] -o | .lhl[uniq] -c
]

## v1 [&gt;]() v2 [&gt;]() v3 [&gt;]() v4 [&gt;]() ... [&gt;]() v42
.time-graph[
## --------------------------------&gt;
## &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time
]
---
class: inverse, middle, center, impic
.immutability[
# immutability
]
---
class: inverse, middle, center
.demo[
`&lt;demo/&gt;`
]
.demo-link[### [github.com/tolitius/funoop/tree/master/curiosity](https://github.com/tolitius/funoop/tree/master/curiosity)]
---
class: inverse, middle, center
# "bits will be bits"
### regardless of [FP]() or [OOP]()

---
class: inverse, middle, center
# business is [orthogonal]()
### to [FP]() or [OOP]()

---
class: inverse, middle, center
# many "[needs]()" stay the [same]()
---
class: inverse, middle, center
# [mutable]() application resources
.right-column[
.lleft[
.same-needs[
### - network connections
### - files
### - databases
### - thread pools workers
### - etc.]]]
---
class: middle, center
.ctm[
<img src="img/clojure-logo.png" width="20%">
]
# [state]() management
---
class: inverse, middle, center
# library [vs.]() framework
---
class: inverse, middle, center
# library [vs.]() framework
.lvf[
## [you]() call library
## [framework]() calls you
]
---
layout: false
class: middle
.left-column[
.mtop-minus-130[
  ## spring [framework]()
]]
.right-column[
.mtop-minus-130[
.bq[<span>IoC is also known as dependency injection</span>
<span>(DI), it's a process whereby .bqh[objects define] their .bqh[dependencies], that is, the other objects they work with</span>
<p>the .bqh[container] then .bqh[injects] those .bqh[dependencies] when it creates the bean.</p>]

.rcc[
## design is based on .rcch[components talking] to each other]
.oop-solid[
.jsf-ms[
Java + Spring......... [makes sense .check[✔]]
]]]]
---
class: inverse, middle, center
.cfa[
<img src="img/clojure-logo.png" width="10%">
]
.cfal[
## dependencies are [function arguments]()
## function is [stateless]() and decoupled from state
## REPL driven development
]
---
class: inverse, middle, center
.cfa[
<img src="img/clojure-logo.png" width="10%">
]
.cfal[
## dependencies are [function arguments]()
## function is [stateless]() and decoupled from state
## REPL driven development

.crepl[
.clj[
```clojure
repl=> (send-message kafka message)
```
]]]
---
class: inverse, middle, center
.cfa[
<img src="img/clojure-logo.png" width="10%">
]
.cfal[
## dependencies are [function arguments]()
## function is [stateless]() and decoupled from state
## REPL driven development

.crepl[
.clj[
```clojure
repl=> (send-message kafka message)
```
.meta[
.meta-repl1[
### ^  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ^ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ^
]
.meta-repl2[
### function &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state &nbsp;&nbsp; other arguments
]]]]]
---
class: inverse, middle, center
.cfa[
<img src="img/clojure-logo.png" width="10%">
# [stateless]() function
### main building block
]
---
class: inverse, middle, center
.cfa[
<img src="img/clojure-logo.png" width="10%">
# [stateless]() function
### main building block
.why-libs[
## apps depend on .jhl[libraries] these .jhl[functions call] out to
]]
---
class: middle, center
# great in theory, [but]() what about..
.what-about[
## database connections
## threadpools
## caches
## etc.
]
---
class: middle, center
# state needs to live [somewhere]()
## regardless of FP or OOP
---
class: inverse, middle, center
# true[.]()
---
class: inverse, middle, center, clojure-dark
.fff[
## .current[state] > configuration > aop > data stores > messaging > portability
]

# atoms
---
class: inverse, middle, center, clojure-dark
.fff[
## .current[state] > configuration > aop > data stores > messaging > portability
]

# atoms
.wt-text[

think AtomicLong, AtomicInteger

but instead ".mcode[AtomicWhateverTypeYouNeed]"
]
---
class: inverse, middle, center, clojure-dark
.fff[
## .current[state] > configuration > aop > data stores > messaging > portability
]

# atoms
.wt-text[

think AtomicLong, AtomicInteger

but instead ".mcode[AtomicWhateverTypeYouNeed]"
<br/><br/>
.es1[
.cblock[
```clojure
(def app-state (atom {}))
```
]
.cblock[
```clojure
(defn start [conf]
  (reset! app-state {:db (db-connect conf)
                     :cache (cache-connect conf)}))
```
]]]
---
class: inverse, middle, center, clojure-dark
.fff[
## .current[state] > configuration > aop > data stores > messaging > portability
]

# atoms
.wt-text[

think AtomicLong, AtomicInteger

but instead ".mcode[AtomicWhateverTypeYouNeed]"
<br/><br/>
.es1[
.cblock[
```clojure
(def app-state (atom {}))
```
]
.cblock[
```clojure
(defn start [conf]
  (reset! app-state {:db (db-connect conf)
                     :cache (cache-connect conf)}))
```
]
.cblock[
```clojure
(defn find-life [{:keys [db]} planet]
  (jdbc/fetch db ["select water from ?" planet]))
```
]]]
---
class: inverse, middle, center, clojure-dark
.fff[
## .current[state] > configuration > aop > data stores > messaging > portability


.demo[
`&lt;demo/&gt;`
]

.demo-link[
### [github.com/tolitius/funoop/tree/master/state](https://github.com/tolitius/funoop/tree/master/state)
]]
---
class: inverse, middle, center, clojure-dark

.fff[
## .current[state] > configuration > aop > data stores > messaging > portability
]

.msp[
## [mount](https://github.com/tolitius/mount) (library)
roughly "Spring _after_ JavaConfig"

.tl[
* states are created anywhere in the app (similar to .tlh[@Component])
* on start mount does a ".tlh[component scan]" and injects dependencies
]]

.osp[
## [component](https://github.com/stuartsierra/component) / [integrant](https://github.com/weavejester/integrant) (frameworks)
roughly "Spring 2.X _before_ JavaConfig"

.tl[
.otl[
* states are defined in one place (similar to .tlh[Spring XML])
* functions that need state have to plugin to the framework
]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > .current[configuration] > aop > data stores > messaging > portability
]

.csp[
* Local Files
* System Properties
* ENV Variables
* Remote Services
  - Zookeeper,
  - Consul
  - etcd
* Secure Stores
  - Vault
  - encrypted in DB
  - keystores
  - secure fs mounts
* etc.
]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > .current[configuration] > aop > data stores > messaging > portability
]

.csp[
* Local Files
* System Properties
* ENV Variables
* Remote Services
  - Zookeeper,
  - Consul
  - etcd
* Secure Stores
  - Vault
  - encrypted in DB
  - keystores
  - secure fs mounts
* etc.
]

.litmus[
.bq[
A litmus test for whether an app has all config correctly factored out of the code is whether the codebase could be made open source at any moment, without compromising any credentials.
]

#### _source: "[12 factor app](https://12factor.net/config)"_]
---
class: middle, center, hubble
---
class: inverse, middle, center, clojure-dark

.fff[
## state > .current[configuration] > aop > data stores > messaging > portability
]


.es2[

# hubble [config]()

.cblock[
```clojure
{:hubble {:server {:port 4242}
          :store {:url "spacecraft://tape"}
          :camera {:mode "mono"}
          :mission {:target "Eagle Nebula"}

          :log {:enabled false
                :auth-token "OVERRIDE ME"
                :name "hubble-log"
                :hazelcast {:hosts "OVERRIDE ME"
                            :group-name "OVERRIDE ME"
                            :group-password "OVERRIDE ME"
                            :retry-ms 5000
                            :retry-max 720000}}

          :vault {:url "OVERRIDE ME"}}}
```
]]
---
class: inverse, middle, center, clojure-dark
.fff[
## state > .current[configuration] > aop > data stores > messaging > portability


.demo[
`&lt;demo/&gt;`
]

.demo-link[
### [github.com/tolitius/hubble](https://github.com/tolitius/hubble)
]]

---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > .current[aop] > data stores > messaging > portability]

.intro[
# [cross]() cutting concerns
.lleft[
.same-needs[
### - logging
### - exception handling
### - transaction management
### - security
### - profiling
### - etc.]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > .current[aop] > data stores > messaging > portability]

.aop-examples[
# [two]()fold
]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > .current[aop] > data stores > messaging > portability]

.aop-examples[
# [two]()fold
.same-needs[
### function composition

.es3[
.cblock[
```clojure
(defn web-app [routes]
  (-> routes
      wrap-cookies
      wrap-params
      wrap-exception-handling))
```
]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > .current[aop] > data stores > messaging > portability]

.aop-examples[
# [two]()fold
.same-needs[
### rebind functions at runtime
.es3[
.es4[
.cblock[
```clojure
(defn process [event] ...)

(alter-var-root process (fn [f]
                            #(do (println "profiling..")
                                 (f %))))
```
]]]]]
---
class: inverse, middle, center, clojure-dark
.fff[
## state > configuration > .current[aop] > data stores > messaging > portability


.demo[
`&lt;demo/&gt;`
]

.demo-link[
### [github.com/tolitius/funoop/tree/master/yaweb](http://github.com/tolitius/funoop/tree/master/yaweb)
]
.demo-link[
### [github.com/tolitius/calip](https://github.com/tolitius/calip)
]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.dstores[
# talking to [data stores]()
# SQL or not
]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.jftw[
# [Java]() libraries FTW
# [Clojure]() libraries on top
### usually to add function composition
]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.jftw[
# SQL
[github.com/clojure/java.jdbc](https://github.com/clojure/java.jdbc)

[github.com/funcool/clojure.jdbc](https://github.com/funcool/clojure.jdbc)
]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.csql[
# SQL

.es5[
.cblock[
```clojure
(def dbspec "postgresql://user:password@localhost:5432/dbname")
```
]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.csql[
# SQL

.es5[
.cblock[
```clojure
(def dbspec "postgresql://user:password@localhost:5432/dbname")
```
.es6[
```clojure
(with-open [conn (jdbc/connection dbspec)]
	  (do-something-with conn))
```
]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.csql[
# SQL

.es5[
.cblock[
```clojure
(def dbspec "postgresql://user:password@localhost:5432/dbname")
```
.es6[
```clojure
(with-open [conn (jdbc/connection dbspec)]
	  (do-something-with conn))
```
]
.es10[
```clojure
(with-open [conn (jdbc/connection dbspec)]
	  (jdbc/execute conn ["insert into foo (name) values (?);"
                          "Foo"]))
```
]
]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.csql[
# SQL

.es5[
.cblock[
```clojure
(def dbspec "postgresql://user:password@localhost:5432/dbname")
```
.es6[
```clojure
(with-open [conn (jdbc/connection dbspec)]
	  (do-something-with conn))
```
]
.es10[
```clojure
(with-open [conn (jdbc/connection dbspec)]
	  (jdbc/execute conn ["insert into foo (name) values (?);"
                          "Foo"]))
```
]
.es7[
```clojure
(jdbc/atomic conn
  (do-thing-first conn)
  (do-thing-second conn))
```
]
]]]

---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.csql[
# SQL

.es5[
.cblock[
.es8[
```clojure
(def ds (hikari/make-datasource
         {:connection-timeout 30000
          :idle-timeout 600000
          :max-lifetime 1800000
          :minimum-idle 10
          :maximum-pool-size  10
          :adapter "postgresql"
          :username "username"
          :password "password"
          :database-name "database"
          :server-name "localhost"
          :port-number 5432}))
```
]
]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.csql[
# SQL

.es5[
.cblock[
.es8[
```clojure
(def ds (hikari/make-datasource
         {:connection-timeout 30000
          :idle-timeout 600000
          :max-lifetime 1800000
          :minimum-idle 10
          :maximum-pool-size  10
          :adapter "postgresql"
          :username "username"
          :password "password"
          :database-name "database"
          :server-name "localhost"
          :port-number 5432}))
```
]
.es9[
```clojure
(with-open [conn (jdbc/connection ds)]
  (do-stuff conn))
```
]
]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.nsql[
# [not]() SQL

.nsql-t[
| | |
|-------------:|:-------------|
| redis     | [github.com/ptaoussanis/carmine](https://github.com/ptaoussanis/carmine) |
| hazelcast | [github.com/tolitius/chazel](https://github.com/tolitius/chazel) |
| cassandra | [github.com/mpenet/alia](https://github.com/mpenet/alia) |
| hbase     | [github.com/tolitius/cbass](https://github.com/tolitius/cbass) |
| neo4j     | [github.com/michaelklishin/neocons](https://github.com/michaelklishin/neocons) |
| dynamo    | [github.com/ptaoussanis/faraday](https://github.com/ptaoussanis/faraday) |
]
]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > .current[data stores] > messaging > portability]

.csql[
.cass[
# [no]()SQL

.es5[
.cblock[
```clojure
(def cluster (alia/cluster {:contact-points ["localhost"]}))
(def session (alia/connect cluster))
```
.es5[
```clojure
(alia/execute session "CREATE KEYSPACE jeeconf
                       WITH replication = {'class': 'SimpleStrategy',
                                           'replication_factor' : 3};")
```
]
.es5[
```clojure
(alia/execute session "USE jeeconf;")
(alia/execute session "CREATE TABLE speakers (nick varchar,
                                              emails set<text>,
                                              created timestamp,
                                              PRIMARY KEY (nick));")
```
]
.es5[
```clojure
(alia/execute session (select :speakers
                              (where {:nick "tolitius"})
                              (columns :emails)))
```
]]]]]
---
class: inverse, middle, center, clojure-dark
.fff[
## state > configuration > aop > .current[data stores] > messaging > portability


.demo[
`&lt;demo/&gt;`
]

.demo-link[
### hazelcast: [github.com/tolitius/chazel](https://github.com/tolitius/chazel)
]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]

.intro[
.msg-meta[
# sending / receiving [events]()
.lleft[
.same-needs[
### - message brokers
### - zeromq
### - message passing
### - etc.
]]]]

---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]
.mheader[

.mh-t[
.msgb[
### brokers
| | |
|-------------:|:-------------|
| aws sqs     | [github.com/aws/aws-sdk-java](https://github.com/aws/aws-sdk-java) |
| kafka       | [github.com/ccann/gregor](https://github.com/ccann/gregor) |
| rabbitmq    | [github.com/michaelklishin/langohr](https://github.com/michaelklishin/langohr) |
]

.ipc[
### brokerless
| | |
|-------------:|:-------------|
| zeromq      | [github.com/zeromq/jeromq](https://github.com/zeromq/jeromq) |
]

.mpass[
### csp
| | |
|-------------:|:-------------|
| core.async  | [github.com/clojure/core.async](https://github.com/clojure/core.async) |
]]

## ... .mhl[|] push, pull .mhl[|] publish, subscribe .mhl[|] produce, consume .mhl[|] put, take .mhl[|] ...
]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]

.aws1[
.csql[
.mass[
# AWS SQS (Java Interop)

.es5[
.cblock[
```clojure
(:import [com.amazonaws ClientConfiguration Protocol]
         [com.amazonaws.auth BasicAWSCredentials]
         [com.amazonaws.regions Region Regions]
         [com.amazonaws.services.sqs AmazonSQSClient]
         [com.amazonaws.services.sqs.model Message
                                           DeleteMessageRequest
                                           ReceiveMessageRequest
                                           GetQueueAttributesRequest]))
```
.es5[
```clojure
(defn create-sqs-client [{:keys [access-key secret-key region]}
                         configs]
  (let [creds (BasicAWSCredentials. access-key secret-key)]
    (doto (AmazonSQSClient. creds configs)
          (.setRegion (Region/getRegion (Regions/fromName region))))))
```
]]]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]

.aws2[
.csql[
.mass[
# AWS SQS (Java Interop)

.es5[
```clojure
(defn receive-messages [{:keys [sqs-client
                                queue-url
                                max-msg
                                visibility-timeout-sec]
                         :or {visibility-timeout-sec 15
                              max-msg 10}}]
  (let [msg-req (doto (ReceiveMessageRequest. queue-url)
                        (.setMaxNumberOfMessages max-msg)
                        (.setVisibilityTimeout visibility-timeout-sec))]
    (mapv message-to-map (.. sqs-client (receiveMessage msg-req)
                                        (getMessages)))))
```
]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]

.kafka1[
.csql[
.mass[
# Kafka

.es5[
.cblock[
```clojure
(defstate consumer :start (gregor/consumer "localhost:9092"
                                           "testgroup"
                                           ["test-topic"]
                                           {"auto.offset.reset" "earliest"
                                            "enable.auto.commit" "false"})
                   :stop (gregor/close consumer))

(defstate producer :start (gregor/producer "localhost:9092")
                   :stop (gregor/close producer))
```
.es5[
```clojure
(let [consumer-records (gregor/poll consumer)
      values (process-records consumer-records)]
  (doseq [v values]
    (gregor/send producer "other-topic" v))
  (gregor/commit-offsets! consumer)))
```
]]]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]

.zero1[
.csql[
.mass[
# zeromq (Java Interop)

.es5[
.cblock[
```clojure
(:import [org.zeromq ZMQ ZMQ$Context ZMQ$Socket ZMQQueue])

(defonce single-context (ZMQ/context 1))

(defn bind [socket url]
  (doto socket
        (.bind url)))

(defn socket [context type]
  (.socket context type))
```
.es5[
```clojure
(defn zsocket [queue]
  (let [sock (-> mq/single-context
                 (mq/socket mq/pub)
                 (mq/bind queue))]
    (log/info "producer is bound to [" queue "], let's rock'n'roll")
    sock))
```
]]]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]

.zero2[
.csql[
.mass[
# zeromq (Java Interop)

.es5[
.cblock[
.es5[
```clojure
(defn subscribe
  ([socket topic]
   (doto socket
     (.subscribe (.getBytes topic))))
  ([socket]
   (subscribe socket "")))
```
]
.es5[
```clojure
(defn send-bytes [^ZMQ$Socket socket ^bytes message]
  (.send socket message 0))

(defn recv-bytes [socket]
  (.recv socket 0))
```
]
]]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > .current[messaging] > portability]

.coreas[
.csql[
.mass[
# Communicating Sequential Processes

.es5[
.cblock[
.es5[
```clojure
(defn GET [url]
  (let [ch (chan)]
    (xhr/send url
              (fn [event]
                (let [res (-> event .-target .getResponseText)]
                  (go (>! ch res))))
              "GET")
    ch))
```
]
.es5[
```clojure
(defn race [q]
  (let [t (timeout timeout-ms)
        start (now)]
    (go
      (alt!
        (GET (str "/yahoo?q=" q))  ([v] (winner :.yahoo v (took start)))
        (GET (str "/bing?q=" q))   ([v] (winner :.bing v (took start)))
        (GET (str "/google?q=" q)) ([v] (winner :.google v (took start)))
        t                          ([v] (show-timeout timeout-ms))))))
```
]
]]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > messaging > .current[portability]]

.intro[
.msg-meta[
# communication [across languages]()
.port-t[
###  Clojure .chl[<=>] Java .chl[<=>] Go .chl[<=>] Rust .chl[<=>] C.chl[<=>] Fortran
]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > messaging > .current[portability]]
.mheader[

.ph-t[
.portb[
### binary
| | |
|-------------:|:-------------|
| avro              | [github.com/damballa/abracad](https://github.com/damballa/abracad)
| protocol buffers  | [github.com/clojusc/protobuf](https://github.com/clojusc/protobuf)
| nippy             | [github.com/ptaoussanis/nippy](https://github.com/ptaoussanis/nippy)
| kryo              | [github.com/sritchie/carbonite](https://github.com/sritchie/carbonite)
| message pack      | [github.com/edma2/clojure-msgpack](https://github.com/edma2/clojure-msgpack)
| transit           | [github.com/cognitect/transit-clj](https://github.com/cognitect/transit-clj)
]

.porth[
### human readable
| | |
|-------------:|:-------------|
| json  | [github.com/dakrone/cheshire](https://github.com/dakrone/cheshire)
| xml   | [github.com/clojure/data.xml](https://github.com/clojure/data.xml)
| yaml  | [github.com/owainlewis/yaml](https://github.com/owainlewis/yaml)
]
]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > messaging > .current[portability]]
.mheader[

.ph-t[
.port-fade[
.portb[
### binary
| | |
|-------------:|:-------------|
| avro              | [github.com/damballa/abracad](https://github.com/damballa/abracad)
| protocol buffers  | [github.com/clojusc/protobuf](https://github.com/clojusc/protobuf)
| .pwhite[nippy]             | <span class="plink">[github.com/ptaoussanis/nippy](https://github.com/ptaoussanis/nippy)</span>
| kryo              | [github.com/sritchie/carbonite](https://github.com/sritchie/carbonite)
| message pack      | [github.com/edma2/clojure-msgpack](https://github.com/edma2/clojure-msgpack)
| .pwhite[transit]           | <span class="plink">[github.com/cognitect/transit-clj](https://github.com/cognitect/transit-clj)</span>
]

.porth[
### human readable
| | |
|-------------:|:-------------|
| json  | [github.com/dakrone/cheshire](https://github.com/dakrone/cheshire)
| xml   | [github.com/clojure/data.xml](https://github.com/clojure/data.xml)
| yaml  | [github.com/owainlewis/yaml](https://github.com/owainlewis/yaml)
]
]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > messaging > .current[portability]]

.portas[
.csql[
.mass[
# transit [| Clojure]()

.es5[
.cblock[
.es5[
```clojure
(defn transit-out [data format opts]
  (let [baos (ByteArrayOutputStream.)
        w    (transit/writer baos format opts)
        _    (transit/write w data)
        ret  (.toByteArray baos)]
    (.reset baos)
    ret))
```
]
.es5[
```clojure
(defn transit-in [data format opts]
  (if (bytes? data)
    (let [bais (ByteArrayInputStream. data)
          r    (transit/reader bais format opts)]
      (transit/read r))
      (log/error "can't deserialize ...")))
```
]
]]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > messaging > .current[portability]]

.jport[
.portas[
.csql[
.mass[
# transit [| Java]()

.es5[
.cblock[
.es5[
```java
import java.io.ByteArrayOutputStream;
import java.io.ByteArrayInputStream;
import com.cognitect.transit.TransitFactory;
import com.cognitect.transit.Reader;
import com.cognitect.transit.Writer;
```
]
.es5[
```java
// Write the data to a stream
OutputStream out = new ByteArrayOutputStream();
Writer writer = TransitFactory.writer(TransitFactory.Format.MSGPACK, out);
writer.write(data);
```
]
.es5[
```java
// Read the data from a stream
InputStream in = new ByteArrayInputStream(out.toByteArray());
Reader reader = TransitFactory.reader(TransitFactory.Format.MSGPACK, in);
Object data = reader.read();
```
]
]]]]]]
---
class: inverse, middle, center, clojure-dark

.fff[
## state > configuration > aop > data stores > messaging > .current[portability]]
.jtport[
.portas[
.csql[
.mass[
# transit [| Java]()
<p class="trava"><a href="https://github.com/danboykis/trava">github.com/danboykis/trava</a></p>
.es5[
.cblock[
.es5[
```clojure
{:a {:b {:c 10}}}
```
]
.es5[
```java
List<Keyword> path = Arrays.asList(new KeywordImpl("a"),
                                   new KeywordImpl("b"),
                                   new KeywordImpl("c"));

Assert.assertEquals(10, Navigator.getIn(nestedMap, path));
```
]
.es5[
```java
// transform this map to {:a {:b {:c 10 :d 1}}}
List<Keyword> newPath = Arrays.asList(new KeywordImpl("a"),
                                      new KeywordImpl("b"),
                                      new KeywordImpl("d"));

Map<Keyword,Object> nestedMap = Navigator.assocIn(nestedMap, newPath, 1);

Assert.assertEquals(1, Navigator.getIn(nestedMap, newPath));
```
]
]]]]]]
---
class: inverse, middle, center

# Clojure [+]() Java
## simple [&]() powerful
---
name: inverse
class: first-slide, center, middle, inverse
#Thank you,
##[@tolitius](https://twitter.com/tolitius)

    </textarea>
    <script src="js/remark-latest.min.js"></script>
    <script>
      var hljs = remark.highlighter.engine;
    </script>
    <script src="js/remark.language.js"></script>
    <script>
      var slideshow = remark.create({
          highlightStyle: 'monokai',
          highlightLanguage: 'remark',
          highlightLines: true
        }) ;
    </script>
  </body>
</html>

